# Series Name Mapping: Legacy vs New Provider

This document maps the series returned by the legacy (ReadingsProvider) and new (PointReadingsProvider) history providers across different time intervals.

**Status**: After alignment work in January 2025, the legacy and new providers now return matching series names. The `matchLegacy=true` parameter can be used to filter new provider output to match legacy series exactly.

## How This Document Was Created

This mapping was generated by running a comparison script that compares `legacy=true` vs `matchLegacy=true` responses:

```bash
# Run the interval comparison script for a specific system
npx tsx scripts/temp/compare-intervals.ts <systemId>

# Example for system 1:
npx tsx scripts/temp/compare-intervals.ts 1
```

The script (`scripts/temp/compare-intervals.ts`) compares:

- **5m interval**: Last 2 days of data
- **30m interval**: Last 7 days of data
- **1d interval**: Last 30 days of data

For each interval, it fetches both `legacy=true` (ReadingsProvider) and `matchLegacy=true` (PointReadingsProvider with legacy filtering) and compares the series returned, including their IDs, data points, and values.

**Note**: This document reflects the state as of January 2025 after series name alignment.

## Series Returned by Both Providers

After the January 2025 alignment work, both providers now return identical series names. The table below shows exactly which series each provider returns for each interval.

### 5-Minute and 30-Minute Intervals

Both providers return **exactly 5 series**:

| Series ID                | Label                   | Type  | Unit | Notes              |
| ------------------------ | ----------------------- | ----- | ---- | ------------------ |
| `source.solar.power.avg` | Solar (total)           | power | W    | ✅ Identical names |
| `load.power.avg`         | Load                    | power | W    | ✅ Identical names |
| `bidi.battery.power.avg` | Battery                 | power | W    | ✅ Identical names |
| `bidi.grid.power.avg`    | Grid                    | power | W    | ✅ Identical names |
| `bidi.battery.soc.last`  | Battery state of charge | soc   | %    | ✅ Identical names |

**Value differences**:

- Legacy: Values rounded to ~1 decimal place precision
- New (matchLegacy): Full precision values
- Difference: Typically < 0.1W (e.g., 156.8 vs 156.75926)

### Daily (1d) Interval

Both providers return **exactly 5 series**:

| Series ID                   | Label                           | Type   | Unit                    | Notes              |
| --------------------------- | ------------------------------- | ------ | ----------------------- | ------------------ |
| `source.solar.energy.delta` | Total solar energy generated    | energy | kWh (legacy) / Wh (new) | ✅ Identical names |
| `load.energy.delta`         | Total load energy consumed      | energy | kWh (legacy) / Wh (new) | ✅ Identical names |
| `bidi.battery.soc.avg`      | Average battery state of charge | soc    | %                       | ✅ Identical names |
| `bidi.battery.soc.min`      | Minimum battery state of charge | soc    | %                       | ✅ Identical names |
| `bidi.battery.soc.max`      | Maximum battery state of charge | soc    | %                       | ✅ Identical names |

**Value differences**:

- Energy series: Legacy returns kWh, new returns Wh (1000x difference)
- SOC series: Small precision differences due to rounding

## Additional Series Available (New Provider Only)

When using the new provider **without** `matchLegacy=true`, these additional series are available:

### Power Series (5m/30m/1d)

- `source.solar.local.power.avg` - Local solar only
- `source.solar.remote.power.avg` - Remote solar only

### Energy Series (5m/30m/1d)

- `source.solar.energy.avg` - Solar energy (cumulative)
- `load.energy.avg` - Load energy (cumulative)
- `bidi.battery.charge.energy.avg` - Battery charging energy
- `bidi.battery.discharge.energy.avg` - Battery discharging energy
- `bidi.grid.import.energy.avg` - Grid import energy
- `bidi.grid.export.energy.avg` - Grid export energy

These additional series provide:

1. **Solar split**: Separate tracking of local vs remote solar
2. **Bidirectional tracking**: Separate charge/discharge and import/export metrics
3. **Energy at all intervals**: Not just daily summaries

## Migration Status

### Completed

- ✅ Series names aligned between legacy and new providers
- ✅ Both providers return identical series when `matchLegacy=true`
- ✅ Dashboard updated to use aligned series names
- ✅ Comparison testing confirmed alignment

### Differences Remaining

- Units: kWh (legacy) vs Wh (new) for energy in daily interval
- Precision: Rounded (legacy) vs full precision (new)
- These differences are expected and acceptable

## Using matchLegacy Parameter

To get identical series output from the new provider:

```bash
# Legacy provider (old tables)
curl "http://localhost:3000/api/history?systemId=1&interval=1d&last=30d&legacy=true"

# New provider with legacy filtering (new tables)
curl "http://localhost:3000/api/history?systemId=1&interval=1d&last=30d&matchLegacy=true"
```

Both return the same series IDs, with only minor value differences (units and precision).
