# Vercel Deployment Guide

## Architecture Overview

The application has been adapted for serverless deployment on Vercel with the following architecture:

### Key Changes from Local Development

1. **Database**: Turso cloud database (SQLite-compatible) replaces local SQLite
2. **Polling**: Vercel Cron jobs replace continuous polling service
3. **Real-time Updates**: Database-backed SSE or polling replaces in-memory state
4. **Authentication**: Stateless cookie-based auth works across serverless functions

### Serverless Components

- **Cron Jobs** (runs every minute):
  - `/api/cron/poll-systems` - Fetches data from select.live
  - `/api/cron/cleanup` - Daily cleanup of old data

- **API Endpoints** (stateless):
  - `/api/data-serverless` - Get latest readings from database
  - `/api/history` - Historical data with 5m aggregation
  - `/api/sse/user-serverless` - Server-sent events from database
  - `/api/auth/*` - Authentication endpoints

## Deployment Steps

### 1. Prerequisites

- Vercel account
- GitHub repository
- Turso database created and populated

### 2. Environment Variables

Set these in Vercel Dashboard > Settings > Environment Variables:

```bash
# Required
TURSO_DATABASE_URL=libsql://your-database.turso.io
TURSO_AUTH_TOKEN=your-auth-token

# Optional (Vercel sets automatically)
CRON_SECRET=<auto-generated-by-vercel>
NODE_ENV=production
```

### 3. Deploy to Vercel

#### Option A: Via Vercel Dashboard

1. Go to [vercel.com/new](https://vercel.com/new)
2. Import your GitHub repository
3. Configure environment variables
4. Deploy

#### Option B: Via CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Deploy
vercel --prod
```

### 4. Verify Deployment

After deployment, verify:

1. **Cron Jobs**: Check Vercel Dashboard > Functions > Cron
2. **Database Connection**: Visit `/api/data-serverless`
3. **History API**: Visit `/api/history?interval=5m&last=1h`
4. **Dashboard**: Login and check real-time data

## Configuration Files

### vercel.json
```json
{
  "crons": [
    {
      "path": "/api/cron/poll-systems",
      "schedule": "* * * * *"  // Every minute
    },
    {
      "path": "/api/cron/cleanup",
      "schedule": "0 2 * * *"   // Daily at 2 AM
    }
  ],
  "functions": {
    "app/api/cron/poll-systems/route.ts": {
      "maxDuration": 60  // Pro plan allows up to 300s
    }
  }
}
```

## Monitoring

### Vercel Dashboard
- **Functions**: Monitor execution time and errors
- **Cron**: View cron job execution history
- **Logs**: Real-time function logs

### Database Monitoring
```bash
# Check database stats
turso db show liveone-prod

# View recent readings
turso db shell liveone-prod "SELECT * FROM readings ORDER BY id DESC LIMIT 5"
```

## Troubleshooting

### Common Issues

1. **Cron not running**
   - Check CRON_SECRET is set
   - Verify cron schedule in vercel.json
   - Check function logs for errors

2. **Database connection fails**
   - Verify TURSO_DATABASE_URL and TURSO_AUTH_TOKEN
   - Check database is accessible from Vercel region

3. **Authentication issues with select.live**
   - Check credentials in USER_SECRETS.ts
   - Verify select.live API is accessible
   - Check for "magic window" timing (minutes 48-52)

4. **Function timeout**
   - Increase maxDuration in vercel.json (Pro plan required for >10s)
   - Optimize database queries
   - Consider splitting work across multiple invocations

### Logs and Debugging

```bash
# View function logs
vercel logs --follow

# Check specific function
vercel logs app/api/cron/poll-systems/route.ts

# Database debugging
turso db shell liveone-prod "SELECT * FROM polling_status"
```

## Cost Considerations

### Vercel (Hobby Plan - Free)
- 100GB bandwidth
- 100GB-hours for serverless functions
- Cron jobs: 2 per day limit (need Pro for every minute)

### Vercel (Pro Plan - $20/month)
- Unlimited cron jobs
- 1TB bandwidth
- 1000GB-hours for serverless functions
- Function duration up to 300s

### Turso (Free Tier)
- 8GB storage
- 1 billion row reads/month
- 25 million row writes/month

### Estimated Usage (per system)
- Cron executions: 43,200/month (every minute)
- Database writes: ~43K/month
- Database reads: ~100K/month (with dashboard polling)
- Function execution: ~72 hours/month

## Security Notes

1. **CRON_SECRET**: Automatically set by Vercel, validates cron requests
2. **Database tokens**: Use read-only tokens where possible
3. **Authentication**: HTTP-only cookies prevent XSS attacks
4. **Environment variables**: Never commit to git, use Vercel's env management

## Migration from Development

To switch between development and production:

### Local Development (with Turso)
```bash
# .env.local
TURSO_DATABASE_URL=libsql://your-dev-database.turso.io
TURSO_AUTH_TOKEN=your-dev-token
```

### Production (Vercel)
- Set environment variables in Vercel Dashboard
- Deploy with `vercel --prod`
- Cron jobs run automatically

## Next Steps

1. **Enable monitoring**: Set up Vercel Analytics
2. **Add error tracking**: Integrate Sentry or similar
3. **Optimize performance**: Add caching, optimize queries
4. **Scale to multiple systems**: Update cron to handle batches
5. **Add MQTT support**: Integrate with home automation